---
title: "airbnb in New York City"
author: "Carole Mattmann und Jonas Zuercher"
date: "13 Februar 2020"
output:
  pdf_document: default
  html_document: default
  word_document: default
---


```{r setup, include=FALSE, echo=TRUE, eval = TRUE}

```

Included packages: 

```{r packages, include=TRUE, echo=TRUE, eval = TRUE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyverse)
library(geosphere)
library(ggplot2)
```

# Introduction
We are exploring a dataset of airbnb listings in New York City in 2019.

# Data import and cleaning

## airbnb dataset

The dataset was downloaded from: https://www.kaggle.com/dgomonov/new-york-city-airbnb-open-data

### Import
```{r import, eval=TRUE, echo=TRUE, include=TRUE}
AB_NYC <- read.csv("../01_data/AB_NYC_2019.csv", header=TRUE)
str(AB_NYC)
```

Following changes have been made to the dataset:

### remove price 0

remove all listings with price 0

```{r price0, include=TRUE, echo=TRUE, eval = TRUE}
AB_NYC <-AB_NYC[AB_NYC$price > 0,]
```

### add log price

add logarithmic price for analysis purposes 
```{r pricelog, include=TRUE, echo=TRUE, eval = TRUE}
AB_NYC <- cbind(AB_NYC,price_log = log(AB_NYC$price))
```

### remove inactive listings

remove inactive listings and make new dataset to compare to full dataset

```{r removeinactive, include=TRUE, echo=TRUE, eval = TRUE}
AB_NYC_available <- AB_NYC %>% 
  filter(availability_365 > 0) 
```

### add distance to Times Square to model

We want to make a statement about how central the place is. Therefore the distance to Times Square is caculated using the latitude and longitude of the listings. The package "geosphere" is used.

Times Square, Manhattan, NY, USA, Latitude and longitude coordinates are: 40.758896, -73.98513

```{r distance_timessquare, include=TRUE, echo=TRUE, eval = TRUE}

coord <- cbind(AB_NYC_available$longitude,AB_NYC_available$latitude)
dist.timessquare <- distGeo(p1=coord, p2=c(-73.985130, 40.758896))
AB_NYC_available <- cbind(AB_NYC_available,dist.timessquare)
```

### Prepare dataset for merging
```{r echo=TRUE}
# write neighbourhood group entries in lower case
AB_NYC_available$neighbourhood_group<-tolower(AB_NYC_available$neighbourhood_group)

#remove spaces from neighbourhood groups
AB_NYC_available$neighbourhood_group <-gsub(" ","", AB_NYC_available$neighbourhood_group)

# neighbourhood group as factor
AB_NYC_available$neighbourhood_group<-factor(AB_NYC_available$neighbourhood_group)
```

## incidents dataset
The dataset was downloaded from: https://data.cityofnewyork.us/City-Government/Agency-Performance-Mapping-Indicators-Annual/gsj6-6rwm 

```{r}
Ind_NYC<- read.csv("../01_data/Indicators_NYC.csv")
head(Ind_NYC)

#Filter Data from 2019
Ind_NYC_2019<-data.frame("neighbourhood_group2"= Ind_NYC$Geographic.Identifier, "Indicator"=Ind_NYC$Indicator,"Incidents"=Ind_NYC$FY2019)
head(Ind_NYC_2019)
Ind_NYC_2019_cleaned<-Ind_NYC_2019


#remove numbers
Ind_NYC_2019_cleaned$neighbourhood_group <-gsub("[0-9]","", Ind_NYC_2019_cleaned$neighbourhood_group2 )
#remove empty spaces
Ind_NYC_2019_cleaned$neighbourhood_group <-gsub(" ","", Ind_NYC_2019_cleaned$neighbourhood_group )
#lowercases
Ind_NYC_2019_cleaned$neighbourhood_group<-tolower(Ind_NYC_2019_cleaned$neighbourhood_group)
#factor
Ind_NYC_2019_cleaned$neighbourhood_group<-factor(Ind_NYC_2019_cleaned$neighbourhood_group)

#overview
head(Ind_NYC_2019_cleaned$Incidents)  
head(Ind_NYC_2019_cleaned$neighbourhood_group)
summary(Ind_NYC_2019_cleaned)
summary(Ind_NYC_2019_cleaned$Indicator)
levels(Ind_NYC_2019_cleaned$neighbourhood_group)

# sum of incidents per neighbourhood group and indicator 
Summary_Ind_NYC_2019<-Ind_NYC_2019_cleaned %>%
  group_by(neighbourhood_group=Ind_NYC_2019_cleaned$neighbourhood_group,Indicator) %>%
  summarise(Observations=sum(Incidents,na.rm = TRUE))
summary(Summary_Ind_NYC_2019)


# remove entries without neighbourhood group
Summary_Ind_NYC_2019<-filter(Summary_Ind_NYC_2019,neighbourhood_group != "")
summary(Summary_Ind_NYC_2019)
head(Summary_Ind_NYC_2019)

# nested indicators
NYC_nest<-Summary_Ind_NYC_2019 %>%
  nest(Indicator=c(Indicator, Observations))
head(NYC_nest)
```
```{r}
#Join both datasets
NYC<-left_join(AB_NYC_available,NYC_nest, by="neighbourhood_group")

# neighbourhood group as factor
NYC$neighbourhood_group<-factor(NYC$neighbourhood_group)
```


# Data visualisation

## Distribution of prices by room types and neighbourhood

```{r plot1, include=TRUE, echo=TRUE, eval = TRUE}

ggplot(data = AB_NYC,
       mapping = aes(y = price_log,
                     x = "",
                     group = neighbourhood_group,
                     colour = neighbourhood_group)) +
  geom_boxplot() +
  facet_wrap(. ~ room_type)+
  xlab("")+
  ylab("log (price in $ per night)")

```

## ?
```{r plots, include=TRUE, echo=TRUE, eval = TRUE}

## price distribution
ggplot(data = AB_NYC,
       mapping = aes(x = price_log,
                     group = room_type,
                     colour = room_type,
                     fill = room_type,
                     alpha = 0.5)) +
  geom_density() +
  xlab("log (price in $ per night)")+
  ylab("density ")

## availability distribution without 0
ggplot(data = AB_NYC_available,
       mapping = aes(x = availability_365)) +
  geom_histogram() +
  xlab("availability")+
  ylab("density ")
```

# Possible models to calculate the price of an airbnb

```{r lm, include=TRUE, echo=TRUE, eval = TRUE}
##simple linear models
lm.hood <- lm (data=AB_NYC_available, price_log~neighbourhood_group)
summary(lm.hood)
lm.type <- lm (data=AB_NYC_available, price_log~room_type)
summary(lm.type)
lm.dist <- lm (data=AB_NYC_available, price_log~dist.timessquare)
summary(lm.dist)
#distance and room type on price (with interaction)
lm.dist.type.interact <- lm (data=AB_NYC_available, price~dist.timessquare*room_type)
summary(lm.dist.type.interact)
ggplot(data = AB_NYC_available,
       mapping = aes(y = price,
                     x = dist.timessquare,
                     colour = room_type,
                     group = room_type)) +
  geom_point(alpha = 0.03) +
  xlab("distance to timessquare in m")+
  ylab("price in $ per night")+
  ylim(0,300)+
  geom_smooth(method="lm")
```

```{r lm2, include=TRUE, echo=TRUE, eval = TRUE}
#multiple linear regression
lm.full <- lm (data=AB_NYC_available, price_log~room_type+neighbourhood_group+minimum_nights+number_of_reviews+calculated_host_listings_count+availability_365+dist.timessquare)
summary(lm.full)
lm.empty <- lm (data=AB_NYC_available, price_log~NULL)
add1(lm.empty,scope=lm.full)
#choose value with smallest RSS
lm.1 <- update(lm.empty,.~.+room_type) 
add1(lm.1,scope=lm.full)
lm.2 <- update(lm.1,.~.+dist.timessquare)
add1(lm.2,scope=lm.full)
lm.3 <- update(lm.2,.~.+availability_365)
add1(lm.3,scope=lm.full)
lm.4 <- update(lm.3,.~.+neighbourhood_group)
add1(lm.4,scope=lm.full)
lm.5 <- update(lm.4,.~.+minimum_nights)
add1(lm.5,scope=lm.full)
summary(lm.5)
```


# Interactive map with the leaflet package

```{r, include=TRUE, echo=TRUE, eval = TRUE}
df_exp<-filter(NYC,price == max(price))
df_cheap<-filter(NYC,price == min(price))
```





